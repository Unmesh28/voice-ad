// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  role          UserRole  @default(USER)
  apiKey        String?   @unique @map("api_key")
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  projects      Project[]
  usageRecords  UsageRecord[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  API_USER
}

model Project {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  scripts     Script[]
  productions Production[]

  @@map("projects")
  @@index([userId])
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model Script {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  title       String
  content     String   @db.Text
  metadata    Json?
  version     Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  productions Production[]

  @@map("scripts")
  @@index([projectId])
}

model Production {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  scriptId    String?  @map("script_id")
  voiceId     String?  @map("voice_id")
  musicId     String?  @map("music_id")
  status      ProductionStatus @default(PENDING)
  settings    Json?
  outputUrl   String?  @map("output_url")
  duration    Int?     // in seconds
  errorMessage String? @map("error_message") @db.Text
  progress    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  script      Script?  @relation(fields: [scriptId], references: [id], onDelete: SetNull)
  music       MusicTrack? @relation(fields: [musicId], references: [id], onDelete: SetNull)

  @@map("productions")
  @@index([projectId])
  @@index([status])
}

enum ProductionStatus {
  PENDING
  GENERATING_VOICE
  GENERATING_MUSIC
  MIXING
  COMPLETED
  FAILED
}

model MusicTrack {
  id          String   @id @default(uuid())
  name        String
  description String?
  genre       String?
  mood        String?
  duration    Int      // in seconds
  fileUrl     String   @map("file_url")
  isGenerated Boolean  @default(false) @map("is_generated")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  productions Production[]

  @@map("music_tracks")
  @@index([genre])
  @@index([mood])
}

model Job {
  id          String   @id @default(uuid())
  type        JobType
  payload     Json
  status      JobStatus @default(PENDING)
  progress    Int      @default(0)
  result      Json?
  errorMessage String? @map("error_message") @db.Text
  attempts    Int      @default(0)
  maxAttempts Int      @default(3) @map("max_attempts")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  @@map("jobs")
  @@index([status])
  @@index([type])
}

enum JobType {
  SCRIPT_GENERATION
  TTS_GENERATION
  MUSIC_GENERATION
  AUDIO_MIXING
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model UsageRecord {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  resourceType ResourceType @map("resource_type")
  quantity    Int      // e.g., characters for TTS, minutes for music
  cost        Float?   // optional cost tracking
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_records")
  @@index([userId])
  @@index([resourceType])
  @@index([createdAt])
}

enum ResourceType {
  TTS_CHARACTERS
  MUSIC_GENERATION
  SCRIPT_GENERATION
  AUDIO_MIXING
}
